<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>シャドーイング練習アプリ</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    :root {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      color-scheme: light;
    }
    body {
      max-width: 720px;
      margin: 0 auto;
      padding: 16px;
      background: #f5f5f7;
    }
    header {
      text-align: center;
      margin-bottom: 16px;
    }
    h1 {
      font-size: 1.4rem;
      margin: 4px 0;
    }
    header p {
      font-size: 0.9rem;
      color: #555;
      margin: 0;
    }
    .card {
      background: #fff;
      border-radius: 12px;
      padding: 12px 14px;
      margin-bottom: 14px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.06);
    }
    .card h2 {
      font-size: 1.0rem;
      margin: 0 0 6px;
    }
    label {
      font-size: 0.9rem;
      font-weight: 600;
    }
    select, button, textarea, input[type="range"] {
      width: 100%;
      box-sizing: border-box;
      margin-top: 4px;
      margin-bottom: 4px;
      padding: 8px;
      font-size: 0.95rem;
    }
    button {
      border-radius: 999px;
      border: none;
      background: #2563eb;
      color: #fff;
      font-weight: 600;
      cursor: pointer;
    }
    button.secondary {
      background: #e5e7eb;
      color: #111827;
    }
    button:disabled {
      opacity: 0.6;
      cursor: default;
    }
    .small {
      font-size: 0.8rem;
      color: #666;
    }
    .row {
      display: flex;
      gap: 8px;
      margin-top: 6px;
    }
    .row > * {
      flex: 1;
    }
    #passageDisplay {
      font-size: 0.95rem;
      line-height: 1.6;
      padding: 8px;
      background: #f9fafb;
      border-radius: 8px;
      min-height: 80px;
    }
    .sentence {
      display: block;
      margin-bottom: 4px;
    }
    .word {
      cursor: pointer;
      border-radius: 4px;
      padding: 1px 2px;
    }
    .word:hover {
      background: #dbeafe;
    }
    #translationBox {
      margin-top: 6px;
      padding: 8px;
      border-radius: 8px;
      background: #fef3c7;
      font-size: 0.9rem;
      display: none;
    }
    audio {
      width: 100%;
      margin-top: 4px;
    }
    #score {
      font-size: 1.1rem;
      font-weight: bold;
      margin-top: 4px;
    }
    #weak-word {
      font-size: 0.9rem;
      margin-top: 2px;
    }
    #historyList {
      font-size: 0.85rem;
    }
    .history-item {
      display: flex;
      justify-content:space-between;
      border-bottom: 1px dashed #e5e7eb;
      padding: 4px 0;
    }
    .pill {
      display:inline-block;
      padding:2px 8px;
      border-radius:999px;
      font-size:0.75rem;
      background:#e5e7eb;
      margin-left:6px;
    }
  </style>
</head>

<body>
<header>
  <h1>教科書シャドーイング練習</h1>
  <p>①レッスン選択 → ②モデル音声 → ③録音 → ④発音チェック</p>
</header>

<!-- レッスン選択 -->
<section class="card">
  <h2>① レッスンを選ぶ</h2>
  <label for="lessonSelect">レッスン</label>
  <select id="lessonSelect"></select>
</section>

<!-- 本文＋訳 -->
<section class="card">
  <h2>② 教科書本文</h2>
  <div id="passageDisplay"></div>
  <div class="row">
    <button id="toggleTranslationBtn" class="secondary" type="button">和訳を表示</button>
    <button id="copyTextBtn" class="secondary" type="button">英文をコピー</button>
  </div>
  <div id="translationBox"></div>
</section>

<!-- 音声 -->
<section class="card">
  <h2>③ モデル音声</h2>
  <audio id="modelAudio" controls>お使いのブラウザは audio をサポートしていません。</audio>
  <label for="speed">再生スピード：<span id="speedValue">1.0x</span></label>
  <input type="range" id="speed" min="0.5" max="1.5" step="0.1" value="1.0" />
</section>

<!-- 録音 -->
<section class="card">
  <h2>④ 録音</h2>
  <div class="row">
    <button id="recordBtn" type="button">● 録音スタート</button>
    <button id="stopBtn" type="button" class="secondary" disabled>■ ストップ</button>
  </div>
  <p id="recordStatus" class="small"></p>
  <div id="recordingsList"></div>
</section>

<!-- 発音チェック -->
<section class="card">
  <h2>⑤ 発音チェック（デモ）</h2>
  <button id="checkBtn" type="button">AIでチェック（仮）</button>
  <div id="score"></div>
  <div id="weak-word"></div>
</section>

<!-- 履歴 -->
<section class="card">
  <h2>⑥ 練習履歴</h2>
  <div id="historyList" class="small"></div>
</section>

<script>
// ==============================
// レッスンデータ —— ★ここに追加済み★
// ==============================
const lessons = [
  {
    id: "lesson1",
    title: "Lesson 1 Sample",
    audioSrc: "lesson1.mp3",
    text: "This is a sample passage for shadowing practice.",
    translation: "これはシャドーイング練習用のサンプル本文です。"
  },
  {
    id: "lesson2",
    title: "Lesson 2 Sample",
    audioSrc: "lesson2.mp3",
    text: "Shadowing helps improve pronunciation, rhythm, and fluency.",
    translation: "シャドーイングは発音・リズム・流暢さを向上させます。"
  },

  /* ★★★ ここから追加レッスン ★★★ */
  {
    id: "R7_listen3",
    title: "R7 1年 普通科 前期中間 リスニング(3)",
    audioSrc: "R7_1_Listening3.mp3",
    text: "（This is English Listening Test）",
    translation: "（これは英語のリスニングテストです。）"
  }
  /* ★★★ 追加ここまで ★★★ */
];

// ==============================
// 要素取得
// ==============================
const lessonSelect = document.getElementById("lessonSelect");
const passageDisplay = document.getElementById("passageDisplay");
const translationBox = document.getElementById("translationBox");
const toggleTranslationBtn = document.getElementById("toggleTranslationBtn");
const copyTextBtn = document.getElementById("copyTextBtn");
const modelAudio = document.getElementById("modelAudio");
const speed = document.getElementById("speed");
const speedValue = document.getElementById("speedValue");
const recordBtn = document.getElementById("recordBtn");
const stopBtn = document.getElementById("stopBtn");
const recordStatus = document.getElementById("recordStatus");
const recordingsList = document.getElementById("recordingsList");
const checkBtn = document.getElementById("checkBtn");
const scoreElem = document.getElementById("score");
const weakWordElem = document.getElementById("weak-word");
const historyList = document.getElementById("historyList");

let currentLesson = null;
let mediaRecorder;
let audioChunks = [];
window.lastRecordingBlob = null;

// ==============================
// レッスン初期化
// ==============================
function initLessonSelect() {
  lessons.forEach(l => {
    const opt = document.createElement("option");
    opt.value = l.id;
    opt.textContent = l.title;
    lessonSelect.appendChild(opt);
  });
  lessonSelect.value = lessons[0].id;
  setLesson(lessons[0].id);
}

lessonSelect.addEventListener("change", () => setLesson(lessonSelect.value));

function setLesson(id) {
  currentLesson = lessons.find(l => l.id === id);
  if (!currentLesson) return;

  renderPassage();
  translationBox.textContent = currentLesson.translation;
  translationBox.style.display = "none";
  toggleTranslationBtn.textContent = "和訳を表示";

  modelAudio.src = currentLesson.audioSrc;
  modelAudio.playbackRate = parseFloat(speed.value);

  renderHistory();
}

// ==============================
// 本文レンダリング
// ==============================
function renderPassage() {
  const text = currentLesson.text;
  passageDisplay.innerHTML = "";

  const sentences = text.split(/(?<=[.!?])\s+/);
  sentences.forEach(s => {
    const span = document.createElement("span");
    span.className = "sentence";
    s.split(/(\s+)/).forEach(tok => {
      if (/^\s+$/.test(tok)) {
        span.appendChild(document.createTextNode(tok));
      } else {
        const clean = tok.replace(/[.,!?;]/g, "");
        const w = document.createElement("span");
        w.className = "word";
        w.dataset.word = clean;
        w.textContent = tok;
        span.appendChild(w);
      }
    });
    passageDisplay.appendChild(span);
  });
}

// 単語タップ→Weblio
passageDisplay.addEventListener("click", e => {
  if (e.target.classList.contains("word")) {
    const w = e.target.dataset.word;
    window.open("https://ejje.weblio.jp/content/" + encodeURIComponent(w), "_blank");
  }
});

// ==============================
// 和訳表示切替
// ==============================
toggleTranslationBtn.addEventListener("click", () => {
  const isHidden = translationBox.style.display === "none";
  translationBox.style.display = isHidden ? "block" : "none";
  toggleTranslationBtn.textContent = isHidden ? "和訳を隠す" : "和訳を表示";
});

// ==============================
// 英文コピー
// ==============================
copyTextBtn.addEventListener("click", async () => {
  await navigator.clipboard.writeText(currentLesson.text);
  copyTextBtn.textContent = "コピーしました";
  setTimeout(() => (copyTextBtn.textContent = "英文をコピー"), 1500);
});

// ==============================
// 再生速度
// ==============================
speed.addEventListener("input", () => {
  modelAudio.playbackRate = parseFloat(speed.value);
  speedValue.textContent = speed.value + "x";
});

// ==============================
// 録音
// ==============================
recordBtn.addEventListener("click", async () => {
  try {
    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
    mediaRecorder = new MediaRecorder(stream);
    audioChunks = [];

    mediaRecorder.ondataavailable = e => audioChunks.push(e.data);

    mediaRecorder.onstop = () => {
      const blob = new Blob(audioChunks, { type: "audio/webm" });
      const url = URL.createObjectURL(blob);
      window.lastRecordingBlob = blob;

      const a = document.createElement("audio");
      a.controls = true;
      a.src = url;

      recordingsList.innerHTML = "";
      recordingsList.appendChild(a);
    };

    mediaRecorder.start();
    recordStatus.textContent = "録音中…";
    recordBtn.disabled = true;
    stopBtn.disabled = false;
  } catch (err) {
    recordStatus.textContent = "マイクが使えません。";
  }
});

stopBtn.addEventListener("click", () => {
  if (mediaRecorder && mediaRecorder.state === "recording") {
    mediaRecorder.stop();
    recordStatus.textContent = "録音を停止しました。";
    recordBtn.disabled = false;
    stopBtn.disabled = true;
  }
});

// ==============================
// 発音チェック（ダミー）
// ==============================
checkBtn.addEventListener("click", () => {
  if (!window.lastRecordingBlob) {
    scoreElem.textContent = "まず録音してください。";
    return;
  }

  const words = currentLesson.text.split(/\s+/).filter(w => w);
  const score = Math.floor(60 + Math.random() * 40);
  const weak = words[Math.floor(Math.random() * words.length)] || "";

  scoreElem.textContent = `スコア：${score}/100`;
  weakWordElem.textContent = `弱点単語：${weak}`;

  saveHistory(currentLesson.id, score, weak);
  renderHistory();
});

// ==============================
// 履歴
// ==============================
const HISTORY_KEY = "shadow_history_v1";

function loadHistory() {
  try {
    return JSON.parse(localStorage.getItem(HISTORY_KEY)) || {};
  } catch {
    return {};
  }
}

function saveHistory(id, score, weakWord) {
  const h = loadHistory();
  if (!h[id]) h[id] = [];
  h[id].push({
    timestamp: new Date().toISOString(),
    score,
    weakWord
  });
  localStorage.setItem(HISTORY_KEY, JSON.stringify(h));
}

function renderHistory() {
  const h = loadHistory();
  const list = h[currentLesson.id] || [];

  historyList.innerHTML = "";
  if (list.length === 0) {
    historyList.textContent = "まだ履歴はありません。";
    return;
  }

  list.slice(-5).reverse().forEach(item => {
    const div = document.createElement("div");
    div.className = "history-item";

    const t = new Date(item.timestamp);
    const ts = `${t.getMonth() + 1}/${t.getDate()} ${t.getHours()}:${String(t.getMinutes()).padStart(2, "0")}`;

    div.innerHTML = `
      <span>${ts}</span>
      <span>スコア ${item.score}<span class="pill">${item.weakWord}</span></span>
    `;

    historyList.appendChild(div);
  });
}

// ==============================
// 初期化
// ==============================
initLessonSelect();
</script>

</body>
</html>
